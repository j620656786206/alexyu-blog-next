---
title: 將公司專案轉換成 Monorepo 遇到的那些事 - 第二篇 如何將現有專案遷移到 Monorepo？完整指南
description: 深入解析如何從多儲存庫（Polyrepo）架構轉型為單一儲存庫（Monorepo），並探討遷移過程中的步驟、挑戰與實際應用。分享我們選擇 Nx 的理由與解決迴圈依賴問題的經驗。
date: '2024-11-29'
slug: transfer-polyrepo-to-monorepo-2
tags: ['monorepo', 'polyrepo', 'nx', '軟體架構', '程式碼管理', '開發效率', 'devOps', 'monorepo 工具', 'circular dependency', '軟體開發', 'ci/cd']
---

# 第二篇 如何將現有專案遷移到 Monorepo？完整指南

## 如何將現有專案遷移到 Monorepo？完整指南

隨著軟體專案的規模與複雜度增加，越來越多的團隊考慮將現有的多儲存庫架構（Polyrepo）轉移到單一儲存庫架構（Monorepo）。但如何有效完成這一轉變，並充分利用 Monorepo 的優勢，是一個值得深入探討的議題。在本文中，我們將分步講解如何從現有專案遷移到 Monorepo，幫助你解決共用程式碼管理、效率提升與協作困難等問題。

### 步驟 1：評估現狀與規劃

#### 1.1 分析專案架構

在開始轉型之前，你需要深入了解現有專案的架構與依賴性。可以透過以下方式進行：

- 識別依賴性：確認各 Repo 之間的模組依賴，例如哪些功能是共用的，哪些是獨立的。
- 整理重複程式碼：找出多 Repo 中相同或相似的程式碼，這些程式碼可以整合為 Monorepo 中的共享函式庫。

#### 1.2 制定遷移計畫

成功的遷移需要周密的規劃，包括：

- 明確的時間表與里程碑。
- 定義哪些模組優先遷移，哪些模組稍後處理。
- 制定測試計畫，確保遷移後的程式碼行為一致。

#### 1.3 選擇合適的工具

目前主流的 Monorepo 工具包括 Nx、Bazel 和 Lerna。其中，Nx 是一個功能全面、易於使用的工具，特別適合中大型團隊。選擇合適的工具可以顯著減少遷移的複雜度。

### 步驟 2：整合儲存庫

#### 2.1 匯入程式碼

將現有 Repo 的程式碼匯入到新的 Monorepo 中，過程中需注意：

- 依據模組功能將程式碼整理到適當的目錄結構中，例如 apps（應用程式）與 libs（共享函式庫）。

#### 2.2 建立統一的工作空間

Monorepo 的核心之一是建立一致的開發環境，包括：

- 工具設定：統一 ESLint、Prettier、Jest 等工具的配置，減少維護成本。
- 構建腳本：使用 Nx 提供的命令行工具簡化構建與測試流程。

### 步驟 3：實現共享功能

#### 3.1 重構共用程式碼

在多儲存庫中，常常會出現重複的程式碼片段。在 Monorepo 中，可以將這些程式碼重構為共享函式庫（Library），提升重用性。例如：

- 工具函式庫：將常用的工具函式（如日期格式化、API 請求工具）抽離到單獨的函式庫中。
- UI 元件庫：建立統一的設計系統，確保各應用的一致性。

#### 3.2 定義模組邊界

為了避免未來專案的耦合問題，需要清晰定義各模組的邊界，確保模組之間的依賴性最小化。例如，可以使用 Nx 提供的「模組限制」（Module Boundaries）功能，限制不必要的跨模組依賴。

#### 3.3 配置版本控制與發布流程

如果共享函式庫需要單獨發布，可以考慮使用工具（如 Nx 的分組版本控制功能）來管理版本號，確保程式碼的穩定性與向後相容性。

### 步驟 4：建立 CI/CD 流程

Monorepo 的一大優勢是簡化了持續整合與部署（CI/CD）的過程。在遷移過程中，應設計一套適合 Monorepo 的 CI/CD 流程，具體包括：

1. 受影響模組檢測：
   - 使用 Nx 的「受影響專案檢測」功能，僅針對修改過的模組進行測試與部署，節省執行時間。
2. 增量構建與快取：
   - 配置本地與遠端快取，避免重複執行相同的任務，加速構建流程。
3. 分階段部署：
   - 根據業務需求，將部署流程分為開發、測試與生產環境，逐步推出新版本。

### 步驟 5：教育與推廣

成功遷移到 Monorepo 後，需要確保團隊成員能快速適應新架構。可以通過以下方式推廣 Monorepo 的使用：

- 培訓工作坊：為團隊成員介紹 Monorepo 的基本概念與工具使用方法。
- 編寫文檔：詳細記錄 Monorepo 的開發流程與最佳實踐，便於新成員上手。
- 建立反饋機制：鼓勵成員提供使用過程中的反饋，持續優化開發體驗。

## 案例分享：我們的 Monorepo 遷移經驗

在過渡到 Monorepo 之前，我們的團隊使用的是多儲存庫架構，並面臨以下挑戰：

1. 程式碼重複：許多功能模組在不同儲存庫中實現了相似的邏輯，導致開發效率低下。
2. 測試與整合困難：當需要修改跨儲存庫的功能時，測試與整合變得非常耗時且容易出錯。
3. 維護成本高：每個儲存庫使用不同的工具與設定，增加了開發者的學習成本。
   在轉型過程中，我們採用了 Nx 作為主要工具，並按照上述步驟逐步完成了遷移。遷移後，我們的開發效率大幅提升，共用模組的管理也變得更加簡單。

### 為何選擇 Nx？

在進行 Monorepo 工具選型時，我們對多個工具（如 Bazel、Lerna、Rush）進行了對比。最終，我們選擇了 Nx，原因如下：

#### 1. 功能全面且專為 Monorepo 設計

- Nx 是專門為 Monorepo 設計的工具，提供了一套完整的解決方案，包括模組依賴分析、任務執行優化以及工作空間管理。
- 它不僅支持多應用程式和函式庫的整合，還能讓我們輕鬆處理多模組間的依賴性。

#### 2. 強大的受影響範圍檢測（Affected Graph）

- Nx 提供了「受影響範圍檢測」功能，僅針對受改動影響的專案執行測試和構建，顯著縮短了開發與整合的時間。
- 例如，如果只修改了某個函式庫，Nx 會智能地避免重新測試或構建不相關的應用程式，這在大型專案中尤為重要。

#### 3. 支援多種技術棧與框架

- Nx 對多種技術棧（如 React、Angular、Node.js）提供了原生支持，適合我們的 React 前端架構。
- 它還能與 TypeScript 無縫整合，並支持內建的 Jest 測試框架和 ESLint 規則。

#### 4. 內建增量快取與分散式執行

- Nx 支持本地快取和 Nx Cloud，確保相同的構建任務不會被重複執行，提升效率。
- 分散式執行則允許我們將大型構建任務分配到多台機器上並行處理，進一步縮短了執行時間。

#### 5. 模組邊界與代碼可見性管理

- Nx 提供模組邊界檢測工具（Enforce Module Boundaries），能防止不必要的模組間依賴，確保專案結構的清晰與穩定。
- 透過設定「可見性規則」，我們可以限制某些函式庫僅供指定的應用程式訪問，增強了代碼的可維護性。

### Nx 的優點

#### 1. 提高開發效率

- 受影響專案執行：僅對修改影響的模組執行任務，避免了不必要的全域性構建。
- 本地與遠端快取：透過 Nx Cloud 或本地存儲，節省重複運行任務的時間。
- 可重用的命令與腳本：Nx 工作空間允許我們統一管理構建、測試與部署腳本，減少重複設定。

#### 2. 改善團隊協作

- 統一的工作環境：所有專案共享一致的工具與配置，降低了新成員上手的難度。
- 原子性提交：跨模組的更改可以在一次提交中完成，避免多儲存庫中版本不一致的問題。

#### 3. 易於維護的依賴性

- Nx 以依賴圖（Dependency Graph）的方式展示專案模組之間的關係，讓開發者可以輕鬆理解和調整模組間的依賴。

#### 4. 開放且靈活

- Nx 是一個開源工具，具有活躍的社群和豐富的文檔，幫助我們快速解決使用中的問題。
- 它還支持客製化腳本與插件，滿足特定業務需求。

### Nx 的挑戰與限制

儘管 Nx 功能強大，但也存在一些需要注意的地方：

#### 1. 學習曲線

- 與傳統的單一儲存庫工具相比，Nx 的功能更全面，但也更複雜。
- 對於剛接觸 Monorepo 或 Nx 的團隊成員來說，可能需要額外的培訓與學習時間。

#### 2. 對超大型專案的性能挑戰

- 在極大型專案中，儘管 Nx 提供了本地與遠端快取，但依賴圖的生成與模組檢測可能會變慢。
- 為了解決這一問題，我們需要對專案進行合理的模組化設計，避免過度依賴單一函式庫。

#### 3. 過度依賴特定工具

- Nx 提供了許多便捷功能，但過度依賴它可能會限制我們在其他工具之間切換的靈活性。
- 在選擇 Nx 時，我們需要確保團隊的開發流程能適應它的生態。

### 選擇 Nx 的總結

我們之所以選擇 Nx，是因為它在功能完整性、開發效率提升以及社群支持方面表現出色。儘管使用 Nx 需要一定的學習成本，但它能有效解決多 Repo 架構中的程式碼共享與效率問題，並為 Monorepo 提供強有力的支持。對於正在考慮將專案遷移到 Monorepo 的團隊，Nx 是一個值得推薦的選擇。

## 遷移過程中的實際應用

在遷移過程中，我們利用 Nx 實現了以下目標：

1. 統一構建與測試流程：透過 Nx Workspace，所有應用程式與函式庫共用相同的構建與測試腳本。
2. 快速增量構建：即使在多模組的專案中，Nx 的受影響範圍檢測功能讓我們能在幾分鐘內完成構建。
3. 依賴管理可視化：透過依賴圖，我們能輕鬆識別模組間的耦合關係並進行優化。

## 結語

選擇合適的 Monorepo 工具是成功轉型的關鍵。Nx 為我們提供了強大的功能與靈活性，幫助我們克服了多 Repo 的挑戰，實現了更高效的開發與協作。如果你的團隊正在尋求一種強大的 Monorepo 工具，不妨考慮 Nx，讓它成為你的開發助力。
